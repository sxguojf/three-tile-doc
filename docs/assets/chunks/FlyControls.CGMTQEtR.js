var F=Object.defineProperty;var P=(t,s,e)=>s in t?F(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var d=(t,s,e)=>P(t,typeof s!="symbol"?s+"":s,e);import{as as K,V as h,Q as M,at as A,au as T,av as z,b as U,aw as W,ax as Q,a1 as H,ay as q,D as $,ar as j,az as B,ai as G,aj as I,aA as X}from"./index.B-YquQ_z.js";import{u as N}from"./useState.EiXjSKHF.js";import{G as O}from"./GLTFLoader.CGzLxAQL.js";import{u as Y}from"./useSky.B8-_WKN9.js";import{u as Z}from"./tween.module.BLfFZSQj.js";import{d as J,p,q as k,v as ee,x as te,c as E,o as x,j as r,a as m,F as oe,B as se,k as ne,t as C,_ as ie}from"./framework.xbTv8SNN.js";const ae={type:"change"},V=1e-6,D=new M;let re=class extends K{constructor(s,e=null){super(s,e),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new h(0,0,0),this._rotationVector=new h(0,0,0),this._lastQuaternion=new M,this._lastPosition=new h,this._status=0,this._onKeyDown=he.bind(this),this._onKeyUp=ce.bind(this),this._onPointerMove=le.bind(this),this._onPointerDown=de.bind(this),this._onPointerUp=me.bind(this),this._onPointerCancel=ue.bind(this),this._onContextMenu=pe.bind(this),e!==null&&this.connect()}connect(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(s){if(this.enabled===!1)return;const e=this.object,n=s*this.movementSpeed,o=s*this.rollSpeed;e.translateX(this._moveVector.x*n),e.translateY(this._moveVector.y*n),e.translateZ(this._moveVector.z*n),D.set(this._rotationVector.x*o,this._rotationVector.y*o,this._rotationVector.z*o,1).normalize(),e.quaternion.multiply(D),(this._lastPosition.distanceToSquared(e.position)>V||8*(1-this._lastQuaternion.dot(e.quaternion))>V)&&(this.dispatchEvent(ae),this._lastQuaternion.copy(e.quaternion),this._lastPosition.copy(e.position))}_updateMovementVector(){const s=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-s+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}};function he(t){if(!(t.altKey||this.enabled===!1)){switch(t.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1;break}this._updateMovementVector(),this._updateRotationVector()}}function ce(t){if(this.enabled!==!1){switch(t.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0;break}this._updateMovementVector(),this._updateRotationVector()}}function de(t){if(this.enabled!==!1)if(this.dragToLook)this._status++;else{switch(t.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1;break}this._updateMovementVector()}}function le(t){if(this.enabled!==!1&&(!this.dragToLook||this._status>0)){const s=this._getContainerDimensions(),e=s.size[0]/2,n=s.size[1]/2;this._moveState.yawLeft=-(t.pageX-s.offset[0]-e)/e,this._moveState.pitchDown=(t.pageY-s.offset[1]-n)/n,this._updateRotationVector()}}function me(t){if(this.enabled!==!1){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(t.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0;break}this._updateMovementVector()}this._updateRotationVector()}}function ue(){this.enabled!==!1&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function pe(t){this.enabled!==!1&&t.preventDefault()}class _e extends A{constructor(e,n={}){super();d(this,"scene");d(this,"renderer");d(this,"camera");d(this,"controls");d(this,"ambLight");d(this,"dirLight");d(this,"container");d(this,"topScenes",[]);d(this,"_clock",new T);const{antialias:o=!1,stencil:i=!0,logarithmicDepthBuffer:l=!0}=n;this.renderer=this._createRenderer(o,i,l),this.scene=this._createScene(),this.camera=this._createCamera(),e&&this.addTo(e),this.controls=this._createControls(),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this.renderer.setAnimationLoop(this.animate.bind(this))}get width(){var e;return((e=this.container)==null?void 0:e.clientWidth)||0}get height(){var e;return((e=this.container)==null?void 0:e.clientHeight)||0}get autoForward(){return this.controls.autoForward}set autoForward(e){this.controls.autoForward=e}addTo(e){const n=typeof e=="string"?document.querySelector(e):e;if(n instanceof HTMLElement)this.container=n,n.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(n);else throw`${e} not found!}`;return this}_createScene(){const e=new z,n=14414079;return e.background=new U(n),e.fog=new W(n,5e-6),e}_createRenderer(e,n,o){const i=new Q({antialias:e,logarithmicDepthBuffer:o,stencil:n,alpha:!0,precision:"highp"});return i.setPixelRatio(window.devicePixelRatio),i.domElement.tabIndex=0,i.domElement.style.outline="none",i}_createCamera(){const e=new H(70,1,100,5e7);return e.position.set(0,28e6,0),e}_createControls(){const e=new re(this.camera,this.renderer.domElement);return e.autoForward=!1,e.movementSpeed=2e3,e.rollSpeed=.05,e}_createAmbLight(){return new q(16777215,1)}_createDirLight(){const e=new $(16777215,1);return e.position.set(0,2e3,1e3),e.target.position.set(0,0,0),e}resize(){const e=this.width,n=this.height;return this.renderer.setSize(e,n),this.camera.aspect=e/n,this.camera.updateProjectionMatrix(),this.update(),this.dispatchEvent({type:"resize",size:{width:e,height:n}}),this}update(){this.renderer.autoClear=!1,this.renderer.render(this.scene,this.camera),this.topScenes.forEach(e=>{this.renderer.clearDepth(),this.renderer.render(e,this.camera)}),this.renderer.autoClear=!0}animate(){this.update();const e=this._clock.getDelta();this.controls.update(e),this.dispatchEvent({type:"update",delta:e}),Z()}}const ve=()=>{const t=new G({imgSource:new X,demSource:new I,lon0:90,minLevel:5,debug:1});return t.rotateX(-Math.PI/2),t},we=t=>{const s=ve(),e=new _e;e.renderer.toneMapping=j,e.renderer.toneMappingExposure=.8,Y(e.scene),e.controls.autoForward=!0,e.controls.dragToLook=!0,e.scene.add(s);const n=new h,o=i=>{const l=s.geo2world(i);e.camera.position.copy(l),e.camera.rotation.set(0,0,0),n.copy(i)};return o(t),{viewer:e,map:s,goto:o,startGeo:n}},fe=async(t,s,e)=>{const o=await new O().loadAsync("../../model/acrobaticPlane_variants.glb"),i=o.scene;i.scale.setScalar(1e3);const l=new B(i);return l.clipAction(o.animations[0]).play(),t.addEventListener("update",w=>{var _;i.position.set(0,-300,-500),t.camera.updateMatrixWorld(),i.applyMatrix4(t.camera.matrixWorld);const f=((_=s.getLocalInfoFromWorld(i.position))==null?void 0:_.point.y)||0,b=i.position.y-f;if(b>-50){const u=new h(0,0,-1e4).applyMatrix4(t.camera.matrixWorld);i.lookAt(u),l.update(w.delta)}e&&e(b,w)}),i},be={class:"map-container"},ge={class:"options",tabindex:"-1"},Se=["onClick"],ye={for:"autoForward"},ke=["checked"],Le={for:"dragToLook"},Ee=["checked"],xe={class:"sound",for:"sound"},Ce=["checked"],Ve={class:"mapState"},De=J({__name:"FlyControls",setup(t){const s={喜马拉雅:new h(86,28,1e4),北京:new h(116.4,39.45,2e3),上海:new h(121.47,31,2e3),重庆:new h(106.54,29,3e3),广州:new h(113.27,23,2e3),西安:new h(108.95,34,2e3),香港:new h(114.07,22.3,2e3),富士山:new h(138.73,35,4e3)},e=p(),n=p(0),{viewer:o,map:i,goto:l,startGeo:w}=we(s.喜马拉雅),f=p(),b=N(f),_=()=>b.update(),u=p(o.controls.autoForward);k(u,c=>o.controls.autoForward=c);const g=p(!o.controls.dragToLook);k(g,c=>o.controls.dragToLook=!c);const v=new Audio("../../sounds/plane.mp3");v.loop=!0;const S=p(!1);k(S,c=>{c?v.play():v.pause()});const R=c=>{c.rotateOnAxis(new h(0,1,0),.2),o.dirLight.intensity=Math.random()*4,o.controls.enabled=!1,setTimeout(()=>{o.controls.enabled||(o.controls.enabled=!0,o.dirLight.intensity=1,l(w))},1e3)};return ee(async()=>{if(!e.value)return;o.addTo(e.value);const c=await fe(o,i,a=>{n.value=a,a<-50&&R(c)});o.scene.add(c),o.addEventListener("update",_)}),te(()=>{o.removeEventListener("update",_),o.controls.disconnect(),o.controls.dispose(),i.dispose(),v.pause(),v.src=""}),(c,a)=>(x(),E("div",be,[r("div",{ref_key:"viewerRef",ref:e,class:"map"},null,512),a[7]||(a[7]=r("div",{id:"help"},[r("b",null,"按任意键开始"),m("，"),r("b",null,"WASD"),m(" 移动，"),r("b",null,"R|F"),m(" 升降，"),r("b",null,"Q|E"),m(" 翻滚，"),r("b",null,"方向键"),m(" 转向")],-1)),r("div",ge,[(x(),E(oe,null,se(s,(y,L)=>r("button",{class:"button",tabindex:"-1",key:L,onClick:Me=>ne(l)(y)},C(L),9,Se)),64)),a[6]||(a[6]=r("br",null,null,-1)),r("label",ye,[a[3]||(a[3]=m("自动前进")),r("input",{type:"checkbox",id:"autoForward",onChange:a[0]||(a[0]=y=>u.value=!u.value),checked:u.value},null,40,ke)]),r("label",Le,[a[4]||(a[4]=m("鼠标跟随")),r("input",{type:"checkbox",id:"dragToLook",onChange:a[1]||(a[1]=y=>g.value=!g.value),checked:g.value},null,40,Ee)]),r("label",xe,[a[5]||(a[5]=m("飞机音效")),r("input",{type:"checkbox",id:"sound",onChange:a[2]||(a[2]=y=>S.value=!S.value),checked:S.value},null,40,Ce)])]),r("div",Ve,[r("div",null,"飞行高度: "+C(n.value.toFixed(0))+" m",1)]),r("div",{class:"stats",ref_key:"statsRef",ref:f},null,512)]))}}),We=ie(De,[["__scopeId","data-v-75075d38"]]);export{We as default};
