var V=Object.defineProperty;var K=(s,t,e)=>t in s?V(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var u=(s,t,e)=>K(s,typeof t!="symbol"?t+"":t,e);import{i as W,V as h,E as q,j as B,k as Q,l as U,b as N,F as G,W as H,m as O,A as X,D as Z,n as $,G as Y,f as J,M as ee,o as te,p as oe,q as j,d as ne,Z as se,Q as re}from"./index.DTcE6LeP.js";import{u as ie,T as S,E as F,a as ae}from"./useState.D--43xZA.js";import{u as ce}from"./useSky.BJdHTgn1.js";import{d as le,a8 as de,p as x,q as ue,v as he,x as me,c as pe,o as we,j as i,a as g,t as L,_ as fe}from"./framework.BZ48x_LH.js";const ge="/three-tile-doc/assets/focus.Bfz2i1p4.png",v=new q(0,0,0,"YXZ"),b=new h,ve={type:"change"},be={type:"lock"},ke={type:"unlock"},z=Math.PI/2;class Le extends W{constructor(t,e=null){super(t,e),this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Ee.bind(this),this._onPointerlockChange=_e.bind(this),this._onPointerlockError=ye.bind(this),this.domElement!==null&&this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return console.warn("THREE.PointerLockControls: getObject() has been deprecated. Use controls.object instead."),this.object}getDirection(t){return t.set(0,0,-1).applyQuaternion(this.object.quaternion)}moveForward(t){if(this.enabled===!1)return;const e=this.object;b.setFromMatrixColumn(e.matrix,0),b.crossVectors(e.up,b),e.position.addScaledVector(b,t)}moveRight(t){if(this.enabled===!1)return;const e=this.object;b.setFromMatrixColumn(e.matrix,0),e.position.addScaledVector(b,t)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Ee(s){if(this.enabled===!1||this.isLocked===!1)return;const t=this.object;v.setFromQuaternion(t.quaternion),v.y-=s.movementX*.002*this.pointerSpeed,v.x-=s.movementY*.002*this.pointerSpeed,v.x=Math.max(z-this.maxPolarAngle,Math.min(z-this.minPolarAngle,v.x)),t.quaternion.setFromEuler(v),this.dispatchEvent(ve)}function _e(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(be),this.isLocked=!0):(this.dispatchEvent(ke),this.isLocked=!1)}function ye(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}let k=!1,P=!1,C=!1,M=!1,A=!1,R=performance.now();const l=new h,E=new h;class xe extends B{constructor(e,o={}){super();u(this,"scene");u(this,"renderer");u(this,"camera");u(this,"controls");u(this,"ambLight");u(this,"dirLight");u(this,"container");u(this,"topScenes",[]);u(this,"_clock",new Q);u(this,"_autoForward",!1);const{antialias:n=!1,stencil:r=!0,logarithmicDepthBuffer:m=!0}=o;this.renderer=this._createRenderer(n,r,m),this.scene=this._createScene(),this.camera=this._createCamera(),e&&this.addTo(e),this.controls=this._createControls(this.camera,this.renderer.domElement),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this.renderer.setAnimationLoop(this.animate.bind(this))}get width(){var e;return((e=this.container)==null?void 0:e.clientWidth)||0}get height(){var e;return((e=this.container)==null?void 0:e.clientHeight)||0}get autoForward(){return this._autoForward}set autoForward(e){k=e,this._autoForward=e}addTo(e){const o=typeof e=="string"?document.querySelector(e):e;if(o instanceof HTMLElement)this.container=o,o.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(o);else throw`${e} not found!}`;return this}_createScene(){const e=new U,o=14414079;return e.background=new N(o),e.fog=new G(o,5e-6),e}_createRenderer(e,o,n){const r=new H({antialias:e,logarithmicDepthBuffer:n,stencil:o,alpha:!0});return r.setPixelRatio(window.devicePixelRatio),r.domElement.tabIndex=0,r.domElement.style.outline="none",r}_createCamera(){const e=new O(70,1,100,1e6);return e.position.set(0,e.far/2,0),e}_createControls(e,o){const n=new Le(e,o);n.maxPolarAngle=Math.PI-.5;const r=function(d){switch(d.code){case"ArrowUp":case"KeyW":k=!0;break;case"ArrowLeft":case"KeyA":C=!0;break;case"ArrowDown":case"KeyS":P=!0;break;case"ArrowRight":case"KeyD":M=!0;break;case"Space":A&&(l.y+=5e3),A=!1;break}},m=function(d){switch(d.code){case"ArrowUp":case"KeyW":k=!1;break;case"ArrowLeft":case"KeyA":C=!1;break;case"ArrowDown":case"KeyS":P=!1;break;case"ArrowRight":case"KeyD":M=!1;break}};return document.addEventListener("keydown",r),document.addEventListener("keyup",m),n}_createAmbLight(){return new X(16777215,1)}_createDirLight(){const e=new Z(16777215,1);return e.position.set(0,2e3,1e3),e}resize(){const e=this.width,o=this.height;return this.renderer.setSize(e,o),this.camera.aspect=e/o,this.camera.updateProjectionMatrix(),this.update(),this.dispatchEvent({type:"resize",size:{width:e,height:o}}),this}update(){const e=performance.now(),o=this.controls;if(o.isLocked){k||(k=this.autoForward);const n=(e-R)/500;l.x-=l.x*10*n,l.z-=l.z*10*n,l.y-=9.8*1e3*n,E.z=Number(k)-Number(P),E.x=Number(M)-Number(C),E.normalize();const r=this.camera.position.y;(k||P)&&(l.z-=E.z*r*5*n),(C||M)&&(l.x-=E.x*r*5*n),o.moveRight(-l.x*n),o.moveForward(-l.z*n),o.object.position.y+=l.y*n,o.object.position.y<r&&(l.y=0,o.object.position.y=r,A=!0)}R=e,this.renderer.render(this.scene,this.camera)}animate(){this.update(),this.dispatchEvent({type:"update",delta:this._clock.getDelta()}),ie()}}const Pe=()=>{const s=new ne({imgSource:new re,demSource:new se,lon0:90,minLevel:8,debug:1});return s.rotateX(-Math.PI/2),s},Ce=s=>{const t=Pe(),e=new xe;e.renderer.toneMapping=$,e.renderer.toneMappingExposure=.8,e.scene.add(t);const o=t.geo2world(s);return e.camera.position.copy(o),{viewer:e,map:t}},Me=(s,t,e,o)=>{const{camera:n,controls:r,renderer:m}=s,d=new Y;t.add(d);const p=new J().load("../images/test.jpg");p.colorSpace="srgb";const w=new ee(new te(400),new oe({map:p,roughness:.2,metalness:.5,transparent:!0}));m.domElement.addEventListener("pointerdown",_=>{if(r.isLocked){if(_.button===2){r.unlock();return}}else{r.lock();return}const a=w.clone();d.add(a),e&&e(a);const c=t.worldToLocal(n.getWorldPosition(new h));a.position.copy(c);const f=t.getLocalInfoFromScreen(n,new j(0,0)),D=f?t.worldToLocal(f.point):t.worldToLocal(n.localToWorld(new h(0,0,-100*1e3))),y=800;new S(a.position).to(D,y).easing(F.Quadratic.Out).start(),new S(a.rotation).to({x:Math.PI*3},y).start(),new S(a.position).to({z:D.z},y).easing(f?F.Quadratic.In:F.Quartic.Out).start().onComplete(()=>{const T=()=>{a.removeFromParent(),a.geometry.dispose(),a.material.dispose()};f?setTimeout(T,10*y):T()});const I=n.position.clone();n.position.sub(n.getWorldDirection(new h).multiplyScalar(1e3)),s.dirLight.intensity=5,setTimeout(()=>{n.position.copy(I),s.dirLight.intensity=1},50)})},Se={class:"map-container",oncontextmenu:"return false;"},Fe={class:"options"},Ae={class:"forward",for:"autoForward"},De=["checked"],Te={class:"sound",for:"sound"},ze=["checked"],Re={class:"mapState"},je=le({__name:"01",setup(s){const t=de({fireCount:0,location:new h,loading:0}),e=x(),{viewer:o,map:n}=Ce(new h(86,28,8e3));ce(o.scene);const r=x(),m=ae(r),d=x(!1);ue(d,a=>o.autoForward=a);const p=new Audio("../sounds/boom.mp3"),w=x(!1),_=()=>{const a=n.getLocalInfoFromScreen(o.camera,new j);a&&t.location.copy(n.world2geo(a.point)),t.loading=n.downloading,m.update()};return he(()=>{if(!e.value){console.error("map container not fonund");return}o.addTo(e.value),Me(o,n,()=>{w.value&&(p.currentTime=0,p.play()),t.fireCount++}),o.addEventListener("update",_)}),me(()=>{o.removeEventListener("update",_),o.controls.disconnect(),o.controls.dispose(),n.dispose(),p.pause(),p.src=""}),(a,c)=>(we(),pe("div",Se,[i("div",{ref_key:"viewerRef",ref:e,class:"map"},null,512),c[4]||(c[4]=i("img",{class:"focus",src:ge,alt:"",width:"48px",height:"48px"},null,-1)),i("div",Fe,[i("label",Ae,[c[2]||(c[2]=g("自动前进")),i("input",{type:"checkbox",id:"autoForward",onChange:c[0]||(c[0]=f=>d.value=!d.value),checked:d.value},null,40,De)]),i("label",Te,[c[3]||(c[3]=g("射击音效")),i("input",{type:"checkbox",id:"sound",onChange:c[1]||(c[1]=f=>w.value=!w.value),checked:w.value},null,40,ze)])]),c[5]||(c[5]=i("div",{id:"help"},[i("b",null,"WASD|Arrow"),g(": 移动 | "),i("b",null,"Space"),g(": 跳跃 | "),i("b",null,"Mouse"),g(": 开火 | "),i("b",null,"Esc"),g(": 退出")],-1)),i("div",Re,[i("div",null,"Loading: "+L(t.loading),1),i("div",null,"FireCount: "+L(t.fireCount),1),i("div",null,"经度: "+L(t.location.x.toFixed(3))+"°",1),i("div",null,"纬度: "+L(t.location.y.toFixed(3))+"°",1),i("div",null,"高度: "+L(t.location.z.toFixed(0))+" m",1)]),i("div",{class:"stats",ref_key:"statsRef",ref:r},null,512)]))}}),Be=fe(je,[["__scopeId","data-v-998c2010"]]);export{Be as default};
