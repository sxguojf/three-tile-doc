var j=Object.defineProperty;var I=(s,o,e)=>o in s?j(s,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[o]=e;var l=(s,o,e)=>I(s,typeof o!="symbol"?o+"":o,e);import{i as V,V as m,E as K,j as W,k as U,l as q,b as B,F as N,W as G,m as H,A as O,D as Q,G as J,M as X,n as Z,o as Y,f as $,p as R,d as ee,Z as te,J as oe}from"./index.BXUrQien.js";import{u as ne,T as P,E as M,a as se}from"./useState.D--43xZA.js";import{u as re}from"./useSky.CSQ3i_TO.js";import{d as ie,a8 as ae,p as C,q as ce,v as le,x as de,c as he,o as ue,j as i,a as v,t as b,_ as me}from"./framework.BZ48x_LH.js";const pe="/three-tile-doc/focus.png",p=new K(0,0,0,"YXZ"),w=new m,we={type:"change"},fe={type:"lock"},ge={type:"unlock"},A=Math.PI/2;class ve extends V{constructor(o,e=null){super(o,e),this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=be.bind(this),this._onPointerlockChange=ke.bind(this),this._onPointerlockError=Le.bind(this),this.domElement!==null&&this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return console.warn("THREE.PointerLockControls: getObject() has been deprecated. Use controls.object instead."),this.object}getDirection(o){return o.set(0,0,-1).applyQuaternion(this.object.quaternion)}moveForward(o){if(this.enabled===!1)return;const e=this.object;w.setFromMatrixColumn(e.matrix,0),w.crossVectors(e.up,w),e.position.addScaledVector(w,o)}moveRight(o){if(this.enabled===!1)return;const e=this.object;w.setFromMatrixColumn(e.matrix,0),e.position.addScaledVector(w,o)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function be(s){if(this.enabled===!1||this.isLocked===!1)return;const o=this.object;p.setFromQuaternion(o.quaternion),p.y-=s.movementX*.002*this.pointerSpeed,p.x-=s.movementY*.002*this.pointerSpeed,p.x=Math.max(A-this.maxPolarAngle,Math.min(A-this.minPolarAngle,p.x)),o.quaternion.setFromEuler(p),this.dispatchEvent(we)}function ke(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(fe),this.isLocked=!0):(this.dispatchEvent(ge),this.isLocked=!1)}function Le(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}let f=!1,_=!1,y=!1,x=!1,S=!1,z=performance.now();const c=new m,k=new m;class Ee extends W{constructor(e,t={}){super();l(this,"scene");l(this,"renderer");l(this,"camera");l(this,"controls");l(this,"ambLight");l(this,"dirLight");l(this,"container");l(this,"topScenes",[]);l(this,"_clock",new U);l(this,"_autoForward",!1);const{antialias:n=!1,stencil:r=!0,logarithmicDepthBuffer:u=!0}=t;this.renderer=this._createRenderer(n,r,u),this.scene=this._createScene(),this.camera=this._createCamera(),e&&this.addTo(e),this.controls=this._createControls(this.camera,this.renderer.domElement),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this.renderer.setAnimationLoop(this.animate.bind(this))}get width(){var e;return((e=this.container)==null?void 0:e.clientWidth)||0}get height(){var e;return((e=this.container)==null?void 0:e.clientHeight)||0}get autoForward(){return this._autoForward}set autoForward(e){f=e,this._autoForward=e}addTo(e){const t=typeof e=="string"?document.querySelector(e):e;if(t instanceof HTMLElement)this.container=t,t.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(t);else throw`${e} not found!}`;return this}_createScene(){const e=new q,t=14414079;return e.background=new B(t),e.fog=new N(t,5e-6),e}_createRenderer(e,t,n){const r=new G({antialias:e,logarithmicDepthBuffer:n,stencil:t,alpha:!0});return r.setPixelRatio(window.devicePixelRatio),r.domElement.tabIndex=0,r.domElement.style.outline="none",r}_createCamera(){const e=new H(70,1,100,1e6);return e.position.set(0,e.far/2,0),e}_createControls(e,t){const n=new ve(e,t);n.maxPolarAngle=Math.PI-.5;const r=function(h){switch(h.code){case"ArrowUp":case"KeyW":f=!0;break;case"ArrowLeft":case"KeyA":y=!0;break;case"ArrowDown":case"KeyS":_=!0;break;case"ArrowRight":case"KeyD":x=!0;break;case"Space":S&&(c.y+=5e3),S=!1;break}},u=function(h){switch(h.code){case"ArrowUp":case"KeyW":f=!1;break;case"ArrowLeft":case"KeyA":y=!1;break;case"ArrowDown":case"KeyS":_=!1;break;case"ArrowRight":case"KeyD":x=!1;break}};return document.addEventListener("keydown",r),document.addEventListener("keyup",u),n}_createAmbLight(){return new O(16777215,1)}_createDirLight(){const e=new Q(16777215,1);return e.position.set(0,2e3,1e3),e}resize(){const e=this.width,t=this.height;return this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.update(),this.dispatchEvent({type:"resize",size:{width:e,height:t}}),this}update(){const e=performance.now(),t=this.controls;if(t.isLocked){f||(f=this.autoForward);const n=(e-z)/500;c.x-=c.x*10*n,c.z-=c.z*10*n,c.y-=9.8*1e3*n,k.z=Number(f)-Number(_),k.x=Number(x)-Number(y),k.normalize();const r=this.camera.position.y;(f||_)&&(c.z-=k.z*r*5*n),(y||x)&&(c.x-=k.x*r*5*n),t.moveRight(-c.x*n),t.moveForward(-c.z*n),t.object.position.y+=c.y*n,t.object.position.y<r&&(c.y=0,t.object.position.y=r,S=!0)}z=e,this.renderer.render(this.scene,this.camera)}animate(){this.update(),this.dispatchEvent({type:"update",delta:this._clock.getDelta()}),ne()}}const _e=()=>{const s=new ee({imgSource:new oe,demSource:new te,lon0:90,minLevel:8,debug:1});return s.rotateX(-Math.PI/2),s},ye=s=>{const o=_e(),e=new Ee;e.scene.add(o);const t=o.geo2world(s);return e.camera.position.copy(t),{viewer:e,map:o}},xe=(s,o,e)=>{const{camera:t,controls:n,renderer:r}=s,u=new J;o.add(u);const h=new X(new Z,new Y({map:new $().load("../test.jpg"),shininess:3,transparent:!0}));r.domElement.addEventListener("click",L=>{if(n.isLocked){if(L.button===2){n.unlock();return}}else{n.lock();return}e();const a=h.clone();a.scale.setScalar(t.position.y/40),u.add(a);const d=o.worldToLocal(t.getWorldPosition(new m));a.position.copy(d);const g=o.getLocalInfoFromScreen(t,new R(0,0)),F=g?o.worldToLocal(g.point):o.worldToLocal(t.localToWorld(new m(0,0,-100*1e3))),E=800;new P(a.position).to(F,E).easing(M.Quadratic.Out).start(),new P(a.rotation).to({x:Math.PI,y:Math.PI,z:Math.PI},E).start(),new P(a.position).to({z:F.z},E).easing(g?M.Quadratic.In:M.Quartic.Out).start().onComplete(()=>{const D=()=>{a.removeFromParent(),a.geometry.dispose(),a.material.dispose()};g?setTimeout(D,10*E):D()});const T=t.position.clone();t.position.sub(t.getWorldDirection(new m).multiplyScalar(1e3)),setTimeout(()=>{t.position.copy(T)},50)})},Pe={class:"map-container"},Me={class:"forward",for:"autoForward"},Ce={class:"mapState"},Se=ie({__name:"01",setup(s){const o=ae({fireCount:0,location:new m,loading:0}),e=C(),{viewer:t,map:n}=ye(new m(86,28,1e4));re(t.scene);const r=C(),u=se(r),h=C(!1);ce(h,a=>t.autoForward=a);const L=()=>{const a=n.getLocalInfoFromScreen(t.camera,new R);a&&o.location.copy(n.world2geo(a.point)),o.loading=n.downloading,u.update()};return le(()=>{if(!e.value){console.error("map container not fonund");return}t.addTo(e.value),xe(t,n,()=>o.fireCount++),t.addEventListener("update",L)}),de(()=>{t.removeEventListener("update",L),n.dispose()}),(a,d)=>(ue(),he("div",Pe,[i("div",{ref_key:"viewerRef",ref:e,class:"map"},null,512),d[2]||(d[2]=i("img",{class:"focus",src:pe,alt:"",width:"48px",height:"48px"},null,-1)),i("label",Me,[d[1]||(d[1]=v("自动前进")),i("input",{type:"checkbox",id:"autoForward",onChange:d[0]||(d[0]=g=>h.value=!h.value)},null,32)]),d[3]||(d[3]=i("div",{id:"help"},[i("b",null,"WASD|Arrow"),v(": 移动 | "),i("b",null,"Space"),v(": 跳跃 | "),i("b",null,"Mouse"),v(": 开火 | "),i("b",null,"Esc"),v(": 退出")],-1)),i("div",Ce,[i("div",null,"Loading: "+b(o.loading),1),i("div",null,"FireCount: "+b(o.fireCount),1),i("div",null,"经度: "+b(o.location.x.toFixed(3))+"°",1),i("div",null,"纬度: "+b(o.location.y.toFixed(3))+"°",1),i("div",null,"高度: "+b(o.location.z.toFixed(0))+" m",1)]),i("div",{class:"stats",ref_key:"statsRef",ref:r},null,512)]))}}),Te=me(Se,[["__scopeId","data-v-ddc7a26a"]]);export{Te as default};
