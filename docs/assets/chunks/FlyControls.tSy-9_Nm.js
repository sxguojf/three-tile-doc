var M=Object.defineProperty;var P=(e,s,t)=>s in e?M(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var d=(e,s,t)=>P(e,typeof s!="symbol"?s+"":s,t);import{aq as K,V as h,Q as R,ar as A,as as T,at as U,b as z,au as W,av as Q,a0 as H,aw as q,D as $,ax as B,ah as G,ai as j,ay as I}from"./index.D-Y8yZZR.js";import{u as X}from"./useSky.D-YiwE1J.js";import{u as N}from"./useState.BDVbIXbi.js";import{G as O}from"./GLTFLoader.CkiCWgjt.js";import{u as Y}from"./tween.module.BLfFZSQj.js";import{d as Z,p,q as k,v as J,x as tt,c as E,o as x,j as r,a as m,F as et,B as ot,k as st,t as V,_ as nt}from"./framework.CJqd0DOR.js";const it={type:"change"},C=1e-6,D=new R;let at=class extends K{constructor(s,t=null){super(s,t),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new h(0,0,0),this._rotationVector=new h(0,0,0),this._lastQuaternion=new R,this._lastPosition=new h,this._status=0,this._onKeyDown=rt.bind(this),this._onKeyUp=ht.bind(this),this._onPointerMove=dt.bind(this),this._onPointerDown=ct.bind(this),this._onPointerUp=lt.bind(this),this._onPointerCancel=mt.bind(this),this._onContextMenu=ut.bind(this),t!==null&&this.connect()}connect(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(s){if(this.enabled===!1)return;const t=this.object,n=s*this.movementSpeed,o=s*this.rollSpeed;t.translateX(this._moveVector.x*n),t.translateY(this._moveVector.y*n),t.translateZ(this._moveVector.z*n),D.set(this._rotationVector.x*o,this._rotationVector.y*o,this._rotationVector.z*o,1).normalize(),t.quaternion.multiply(D),(this._lastPosition.distanceToSquared(t.position)>C||8*(1-this._lastQuaternion.dot(t.quaternion))>C)&&(this.dispatchEvent(it),this._lastQuaternion.copy(t.quaternion),this._lastPosition.copy(t.position))}_updateMovementVector(){const s=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-s+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}};function rt(e){if(!(e.altKey||this.enabled===!1)){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1;break}this._updateMovementVector(),this._updateRotationVector()}}function ht(e){if(this.enabled!==!1){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0;break}this._updateMovementVector(),this._updateRotationVector()}}function ct(e){if(this.enabled!==!1)if(this.dragToLook)this._status++;else{switch(e.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1;break}this._updateMovementVector()}}function dt(e){if(this.enabled!==!1&&(!this.dragToLook||this._status>0)){const s=this._getContainerDimensions(),t=s.size[0]/2,n=s.size[1]/2;this._moveState.yawLeft=-(e.pageX-s.offset[0]-t)/t,this._moveState.pitchDown=(e.pageY-s.offset[1]-n)/n,this._updateRotationVector()}}function lt(e){if(this.enabled!==!1){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(e.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0;break}this._updateMovementVector()}this._updateRotationVector()}}function mt(){this.enabled!==!1&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function ut(e){this.enabled!==!1&&e.preventDefault()}class pt extends A{constructor(t,n={}){super();d(this,"scene");d(this,"renderer");d(this,"camera");d(this,"controls");d(this,"ambLight");d(this,"dirLight");d(this,"container");d(this,"topScenes",[]);d(this,"_clock",new T);const{antialias:o=!1,stencil:i=!0,logarithmicDepthBuffer:l=!0}=n;this.renderer=this._createRenderer(o,i,l),this.scene=this._createScene(),this.camera=this._createCamera(),t&&this.addTo(t),this.controls=this._createControls(),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this.renderer.setAnimationLoop(this.animate.bind(this))}get width(){var t;return((t=this.container)==null?void 0:t.clientWidth)||0}get height(){var t;return((t=this.container)==null?void 0:t.clientHeight)||0}get autoForward(){return this.controls.autoForward}set autoForward(t){this.controls.autoForward=t}addTo(t){const n=typeof t=="string"?document.querySelector(t):t;if(n instanceof HTMLElement)this.container=n,n.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(n);else throw`${t} not found!}`;return this}_createScene(){const t=new U,n=14414079;return t.background=new z(n),t.fog=new W(n,5e-6),t}_createRenderer(t,n,o){const i=new Q({antialias:t,logarithmicDepthBuffer:o,stencil:n,alpha:!0,precision:"highp"});return i.setPixelRatio(window.devicePixelRatio),i.domElement.tabIndex=0,i.domElement.style.outline="none",i}_createCamera(){const t=new H(70,1,100,5e7);return t.position.set(0,28e6,0),t}_createControls(){const t=new at(this.camera,this.renderer.domElement);return t.autoForward=!1,t.movementSpeed=2e3,t.rollSpeed=.05,t}_createAmbLight(){return new q(16777215,1)}_createDirLight(){const t=new $(16777215,1);return t.position.set(0,2e3,1e3),t.target.position.set(0,0,0),t}resize(){const t=this.width,n=this.height;return this.renderer.setSize(t,n),this.camera.aspect=t/n,this.camera.updateProjectionMatrix(),this.update(),this.dispatchEvent({type:"resize",size:{width:t,height:n}}),this}update(){this.renderer.autoClear=!1,this.renderer.render(this.scene,this.camera),this.topScenes.forEach(t=>{this.renderer.clearDepth(),this.renderer.render(t,this.camera)}),this.renderer.autoClear=!0}animate(){this.update();const t=this._clock.getDelta();this.controls.update(t),this.dispatchEvent({type:"update",delta:t}),Y()}}const _t=()=>{const e=new G({imgSource:new I,demSource:new j,lon0:90,minLevel:5,debug:1});return e.rotateX(-Math.PI/2),e},vt=e=>{const s=_t(),t=new pt;t.controls.autoForward=!0,t.controls.dragToLook=!0,t.scene.add(s);const n=new h,o=i=>{const l=s.geo2world(i);t.camera.position.copy(l),t.camera.rotation.set(0,0,0),n.copy(i)};return o(e),{viewer:t,map:s,goto:o,startGeo:n}},wt=async(e,s,t)=>{const o=await new O().loadAsync("./acrobaticPlane_variants.glb"),i=o.scene;i.scale.setScalar(1e3);const l=new B(i);return l.clipAction(o.animations[0]).play(),e.addEventListener("update",w=>{var _;i.position.set(0,-300,-500),e.camera.updateMatrixWorld(),i.applyMatrix4(e.camera.matrixWorld);const f=((_=s.getLocalInfoFromWorld(i.position))==null?void 0:_.point.y)||0,b=i.position.y-f;if(b>-50){const u=new h(0,0,-1e4).applyMatrix4(e.camera.matrixWorld);i.lookAt(u),l.update(w.delta)}t&&t(b,w)}),i},ft={class:"map-container"},bt={class:"options",tabindex:"-1"},gt=["onClick"],St={for:"autoForward"},yt=["checked"],kt={for:"dragToLook"},Lt=["checked"],Et={class:"sound",for:"sound"},xt=["checked"],Vt={class:"mapState"},Ct=Z({__name:"FlyControls",setup(e){const s={喜马拉雅:new h(86,28,1e4),北京:new h(116.4,39.45,2e3),上海:new h(121.47,31,2e3),重庆:new h(106.54,29,3e3),广州:new h(113.27,23,2e3),西安:new h(108.95,34,2e3),香港:new h(114.07,22.3,2e3),富士山:new h(138.73,35,4e3)},t=p(),n=p(0),{viewer:o,map:i,goto:l,startGeo:w}=vt(s.喜马拉雅),f=p(),b=N(f),_=()=>b.update(),u=p(o.controls.autoForward);k(u,c=>o.controls.autoForward=c);const g=p(!o.controls.dragToLook);k(g,c=>o.controls.dragToLook=!c);const v=new Audio("./plane.mp3");v.loop=!0;const S=p(!1);k(S,c=>{c?v.play():v.pause()}),X(o.scene);const F=c=>{c.rotateOnAxis(new h(0,1,0),.2),o.dirLight.intensity=Math.random()*4,o.controls.enabled=!1,setTimeout(()=>{o.controls.enabled||(o.controls.enabled=!0,o.dirLight.intensity=1,l(w))},1e3)};return J(async()=>{if(!t.value)return;o.addTo(t.value);const c=await wt(o,i,a=>{n.value=a,a<-50&&F(c)});o.scene.add(c),o.addEventListener("update",_)}),tt(()=>{o.removeEventListener("update",_),o.controls.disconnect(),o.controls.dispose(),i.dispose(),v.pause(),v.src=""}),(c,a)=>(x(),E("div",ft,[r("div",{ref_key:"viewerRef",ref:t,class:"map"},null,512),a[7]||(a[7]=r("div",{id:"help"},[r("b",null,"按任意键开始"),m("，"),r("b",null,"WASD"),m(" 移动，"),r("b",null,"R|F"),m(" 升降，"),r("b",null,"Q|E"),m(" 翻滚，"),r("b",null,"方向键"),m(" 转向")],-1)),r("div",bt,[(x(),E(et,null,ot(s,(y,L)=>r("button",{class:"button",tabindex:"-1",key:L,onClick:Dt=>st(l)(y)},V(L),9,gt)),64)),a[6]||(a[6]=r("br",null,null,-1)),r("label",St,[a[3]||(a[3]=m("自动前进")),r("input",{type:"checkbox",id:"autoForward",onChange:a[0]||(a[0]=y=>u.value=!u.value),checked:u.value},null,40,yt)]),r("label",kt,[a[4]||(a[4]=m("鼠标跟随")),r("input",{type:"checkbox",id:"dragToLook",onChange:a[1]||(a[1]=y=>g.value=!g.value),checked:g.value},null,40,Lt)]),r("label",Et,[a[5]||(a[5]=m("飞机音效")),r("input",{type:"checkbox",id:"sound",onChange:a[2]||(a[2]=y=>S.value=!S.value),checked:S.value},null,40,xt)])]),r("div",Vt,[r("div",null,"飞行高度: "+V(n.value.toFixed(0))+" m",1)]),r("div",{class:"stats",ref_key:"statsRef",ref:f},null,512)]))}}),zt=nt(Ct,[["__scopeId","data-v-4eb06a25"]]);export{zt as default};
