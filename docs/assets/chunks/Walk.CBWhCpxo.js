import{v as U,x as F,d as K,p as T,c as H,o as z,j as p,t as L,k as A,a as S,a4 as R,aa as E,ab as P,_ as q}from"./framework.xbTv8SNN.js";import{L as Q,g as I,k as D,j as X,W as Y,q as M,b as Z,ad as J,M as O,D as $,az as j,i as W,Q as ee,V as v,aB as te,ai as oe,aj as se,aA as re,al as ne,ar as ae}from"./index.xb0hfx6i.js";import{a as ie,b as ce,u as le}from"./style.n9PNkupe.js";import{u as de}from"./useState.EiXjSKHF.js";import{a as ue}from"./useSky.Cg87coJi.js";import{u as fe}from"./useFog.D4XtqScj.js";import{G as pe}from"./GLTFLoader.D-rR401k.js";const x=new WeakMap;class he extends Q{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,s){const o=new I(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,n=>{this.parse(n,t,s)},r,s)}parse(e,t,r=()=>{}){this.decodeDracoFile(e,t,null,null,D,r).catch(r)}decodeDracoFile(e,t,r,s,o=X,n=()=>{}){const i={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!r,vertexColorSpace:o};return this.decodeGeometry(e,i).then(t).catch(n)}decodeGeometry(e,t){const r=JSON.stringify(t);if(x.has(e)){const c=x.get(e);if(c.key===r)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const o=this.workerNextTaskID++,n=e.byteLength,i=this._getWorker(o,n).then(c=>(s=c,new Promise((h,u)=>{s._callbacks[o]={resolve:h,reject:u},s.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return i.catch(()=>!0).then(()=>{s&&o&&this._releaseTask(s,o)}),x.set(e,{key:r,promise:i}),i}_createGeometry(e){const t=new Y;e.index&&t.setIndex(new M(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const s=e.attributes[r],o=s.name,n=s.array,i=s.itemSize,c=new M(n,i);o==="color"&&(this._assignVertexColorSpace(c,s.vertexColorSpace),c.normalized=!(n instanceof Float32Array)),t.setAttribute(o,c)}return t}_assignVertexColorSpace(e,t){if(t!==D)return;const r=new Z;for(let s=0,o=e.count;s<o;s++)r.fromBufferAttribute(e,s),J.toWorkingColorSpace(r,D),e.setXYZ(s,r.r,r.g,r.b)}_loadLibrary(e,t){const r=new I(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((s,o)=>{r.load(e,s,void 0,o)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(r=>{const s=r[0];e||(this.decoderConfig.wasmBinary=r[1]);const o=me.toString(),n=["/* draco decoder */",s,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([n]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(o){const n=o.data;switch(n.type){case"decode":s._callbacks[n.id].resolve(n);break;case"error":s._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,o){return s._taskLoad>o._taskLoad?-1:1});const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function me(){let a,e;onmessage=function(n){const i=n.data;switch(i.type){case"init":a=i.decoderConfig,e=new Promise(function(u){a.onModuleLoaded=function(m){u({draco:m})},DracoDecoderModule(a)});break;case"decode":const c=i.buffer,h=i.taskConfig;e.then(u=>{const m=u.draco,l=new m.Decoder;try{const y=t(m,l,new Int8Array(c),h),g=y.attributes.map(f=>f.array.buffer);y.index&&g.push(y.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:y},g)}catch(y){console.error(y),self.postMessage({type:"error",id:i.id,error:y.message})}finally{m.destroy(l)}});break}};function t(n,i,c,h){const u=h.attributeIDs,m=h.attributeTypes;let l,y;const g=i.GetEncodedGeometryType(c);if(g===n.TRIANGULAR_MESH)l=new n.Mesh,y=i.DecodeArrayToMesh(c,c.byteLength,l);else if(g===n.POINT_CLOUD)l=new n.PointCloud,y=i.DecodeArrayToPointCloud(c,c.byteLength,l);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!y.ok()||l.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+y.error_msg());const f={index:null,attributes:[]};for(const d in u){const k=self[m[d]];let b,_;if(h.useUniqueIDs)_=u[d],b=i.GetAttributeByUniqueId(l,_);else{if(_=i.GetAttributeId(l,n[u[d]]),_===-1)continue;b=i.GetAttribute(l,_)}const C=s(n,i,l,d,k,b);d==="color"&&(C.vertexColorSpace=h.vertexColorSpace),f.attributes.push(C)}return g===n.TRIANGULAR_MESH&&(f.index=r(n,i,l)),n.destroy(l),f}function r(n,i,c){const u=c.num_faces()*3,m=u*4,l=n._malloc(m);i.GetTrianglesUInt32Array(c,m,l);const y=new Uint32Array(n.HEAPF32.buffer,l,u).slice();return n._free(l),{array:y,itemSize:1}}function s(n,i,c,h,u,m){const l=m.num_components(),g=c.num_points()*l,f=g*u.BYTES_PER_ELEMENT,d=o(n,u),k=n._malloc(f);i.GetAttributeDataArrayForAllPoints(c,m,d,f,k);const b=new u(n.HEAPF32.buffer,k,g).slice();return n._free(k),{name:h,array:b,itemSize:l}}function o(n,i){switch(i){case Float32Array:return n.DT_FLOAT32;case Int8Array:return n.DT_INT8;case Int16Array:return n.DT_INT16;case Int32Array:return n.DT_INT32;case Uint8Array:return n.DT_UINT8;case Uint16Array:return n.DT_UINT16;case Uint32Array:return n.DT_UINT32}}}const w={key:[0,0,0],ease:new v,up:new v(0,1,0),rotate:new ee,current:"Run",fadeDuration:.5,runVelocity:400,walkVelocity:80};function G(a){const e=w.key;switch(a.code){case"ArrowUp":case"KeyW":case"KeyZ":e[0]=-1;break;case"ArrowDown":case"KeyS":e[0]=1;break;case"ArrowLeft":case"KeyA":case"KeyQ":e[1]=-1;break;case"ArrowRight":case"KeyD":e[1]=1;break;case"ShiftLeft":case"ShiftRight":e[2]=1;break}}function N(a){const e=w.key;switch(a.code){case"ArrowUp":case"KeyW":case"KeyZ":e[0]=e[0]<0?0:e[0];break;case"ArrowDown":case"KeyS":e[0]=e[0]>0?0:e[0];break;case"ArrowLeft":case"KeyA":case"KeyQ":e[1]=e[1]<0?0:e[1];break;case"ArrowRight":case"KeyD":e[1]=e[1]>0?0:e[1];break;case"ShiftLeft":case"ShiftRight":e[2]=0;break}}function V(a){const e=w.key;if(a.button===0){const{currentTarget:t,offsetX:r,offsetY:s}=a;if(t instanceof HTMLElement){const o=t.clientWidth,n=t.clientHeight,i=new W(r/o*2-1,s/n*2-1);i.y<-.1||i.y>.1?e[0]=Math.sign(i.y):e[0]=0,i.x<-.1||i.x>.1?e[1]=Math.sign(i.x):e[1]=0}}else a.button===2&&(e[0]=0,e[1]=0,w.rotate.set(0,0,0,1))}function B(a){a.button}function ye(){const a=new $(16777215,2);a.castShadow=!0,a.position.set(0,5,-2),a.shadow.camera.visible=!0;const e=a.shadow.camera;return e.far=300,e.near=100,e.left=-100,e.right=100,e.top=100,e.bottom=-200,a}const ge=a=>{const e=new j(a.scene),t=a.animations,r={Idle:e.clipAction(t[0]),Walk:e.clipAction(t[3]),Run:e.clipAction(t[1])};for(const s in r){const o=r[s];o.enabled=!0,o.setEffectiveTimeScale(1),s!=="Idle"&&o.setEffectiveWeight(0)}return{mixer:e,actions:r}};function we(a,e,t,r){const s=a.getLocalInfoFromWorld(r);if(s){const o=e.target.clone();e.target.copy(s.point),o.sub(e.target),t.position.sub(o)}}function ke(a,e,t,r,s,o,n){const i=w.fadeDuration,c=w.key,h=w.up,u=w.ease,m=w.rotate,l=e.getAzimuthalAngle(),g=!(c[0]===0&&c[1]===0)?c[2]?"Run":"Walk":"Idle";if(w.current!=g){const f=o[g],d=o[w.current];w.current=g,f.enabled=!0,f.setEffectiveTimeScale(1),f.setEffectiveWeight(1),d.fadeOut(i),f.reset().fadeIn(i).play()}if(w.current!=="Idle"){let f=function(_){return Math.atan2(Math.sin(_),Math.cos(_))};const d=w.current=="Run"?w.runVelocity:w.walkVelocity;u.set(c[1],0,c[0]).multiplyScalar(d*n);const k=f(Math.atan2(u.x,u.z)+l);m.setFromAxisAngle(h,k),w.ease.applyAxisAngle(h,l);const b=e.target.clone().add(u);we(t,e,a,b),r.quaternion.rotateTowards(m,-.05),r.position.copy(e.target)}s.update(n)}const _e=async(a,e,t)=>{const r=await Le(a),s=r.scene,o=ye();o.target=s,s.add(o);const{mixer:n,actions:i}=ge(r),c=e.renderer.domElement;return c.addEventListener("keydown",G),c.addEventListener("keyup",N),c.addEventListener("mousedown",V),c.addEventListener("mouseup",B),e.addEventListener("update",h=>ke(e.camera,e.controls,t,s,n,i,h.delta)),e.scene.add(s),s};async function Le(a){const e=new he;e.setDecoderPath("../lib/draco/gltf/");const t=new pe;t.setDRACOLoader(e);const r=await t.loadAsync(a),s=r.scene;return s.scale.setScalar(50),s.traverse(function(o){o instanceof O&&(o.name=="vanguard_Mesh"?(o.castShadow=!0,o.receiveShadow=!0,o.material.metalness=1,o.material.roughness=.2,o.material.color.set(1,1,1),o.material.metalnessMap=o.material.map):(o.material.metalness=1,o.material.roughness=0,o.material.transparent=!0,o.material.opacity=.8,o.material.color.set(1,1,1)))}),r}const be=(a,e)=>{a.removeFromParent(),a.traverse(function(t){t instanceof O&&(t.material.dispose(),t.geometry.dispose())}),e.removeEventListener("keydown",G),e.removeEventListener("keyup",N),e.removeEventListener("mousedown",V),e.removeEventListener("mouseup",B)},Ae=()=>{const a=oe.create({imgSource:new re,demSource:new se,lon0:90});return a.rotateX(-Math.PI/2),a.receiveShadow=!0,a},ve=()=>{const a=new ne(void 0,{antialias:!0,logarithmicDepthBuffer:!1});return a.controls.stopListenToKeyEvents(),a.renderer.shadowMap.enabled=!0,a.dirLight.intensity=.5,a.renderer.toneMapping=ae,a.renderer.toneMappingExposure=.6,a},Te=()=>{const a=Ae(),e=ve();return setTimeout(()=>{e.addEventListener("update",()=>{te(a,e.camera)})},5e3),{viewer:e,map:a}},Se=a=>{const{viewer:e,map:t}=Te();return U(()=>{a&&a.value&&(e.addTo(a.value),e.scene.add(t))}),F(()=>{t.dispose()}),{viewer:e,map:t}},De={class:"demo-container"},xe={class:"state"},Ce={class:"location"},Re={class:"loading"},Ee={class:"model-state"},Pe={class:"options"},Ie={for:"fogFactor"},Me={for:"fogColor"},Ue=K({__name:"Walk",setup(a){const e=T(void 0),{viewer:t,map:r}=Se(e),s=ie(r,t),o=ce(r),n=T(new v);ue(t.scene);const{fogFactor:i,fogColor:c}=fe(t),h=T();le(t.controls,h);const u=T(),m=de(u),l=()=>{m.update();const f=r.getLocalInfoFromScreen(t.camera,new W);f&&n.value.copy(f.location)},y=(f,d)=>{t.controls.target.copy(r.geo2world(f)),t.camera.position.copy(r.geo2world(d))};let g;return U(async()=>{const f=new v(94.39977,36.0022,4085.5),d=new v(94.4003,36.0043,4185);y(f,d),t.addEventListener("update",l),g=await _e("../../model/Soldier.glb",t,r),g.position.copy(t.controls.target)}),F(()=>{be(g,t.renderer.domElement)}),(f,d)=>(z(),H("div",De,[p("div",{ref_key:"viewerRef",ref:e,class:"viewer"},null,512),d[4]||(d[4]=p("div",{id:"help"},[p("b",null,"鼠标左键|方向键|WASD移动, shift加速, 鼠标右键旋转地图")],-1)),p("div",{class:"compass",ref_key:"compassRef",ref:h},null,512),p("div",xe,[p("div",Ce,[p("span",null,"经度："+L(A(s).x.toFixed(6))+"° ",1),p("span",null,"纬度："+L(A(s).y.toFixed(6))+"° ",1),p("span",null,"海拔："+L(A(s).z.toFixed(1))+"m ",1)]),p("div",Re,L(A(o)),1)]),p("div",Ee,[p("span",null,"经度:"+L(n.value.x.toFixed(6))+"°",1),p("span",null,"纬度:"+L(n.value.y.toFixed(6))+"°",1),p("span",null,"高度:"+L(n.value.z.toFixed(1))+"m",1)]),p("div",Pe,[p("label",Ie,[d[2]||(d[2]=S("雾浓度 ")),R(p("input",{type:"range",id:"fogFactor",min:"0",max:"2",step:"0.1","onUpdate:modelValue":d[0]||(d[0]=k=>P(i)?i.value=k:null)},null,512),[[E,A(i)]]),S(L(A(i)),1)]),p("label",Me,[d[3]||(d[3]=S("雾颜色 ")),R(p("input",{type:"color",id:"fogColor","onUpdate:modelValue":d[1]||(d[1]=k=>P(c)?c.value=k:null)},null,512),[[E,A(c)]])])]),p("div",{class:"stats",ref_key:"statsRef",ref:u},null,512)]))}}),Ke=q(Ue,[["__scopeId","data-v-5e16149d"]]);export{Ke as default};
