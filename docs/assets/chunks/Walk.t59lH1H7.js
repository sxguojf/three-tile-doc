import{v as M,x as U,d as N,p as T,c as B,o as V,j as p,t as A,k as b,a as K,a4 as C,a9 as x,aa as P,_ as z}from"./framework.BQo5SrHh.js";import{L as H,g as I,k as D,j as q,W as Q,q as E,b as Z,ad as X,M as F,D as Y,az as J,V as v,Q as $,aB as j,ai as ee,aj as te,aA as oe,al as se,ay as re,i as ne}from"./index.B0Mz6VAy.js";import{a as ae,b as ie,u as ce}from"./style.B3RjSc2H.js";import{u as le}from"./useState.BEDzeVK5.js";import{a as de}from"./useSky.ByY0yeG8.js";import{u as ue}from"./useFog.nsXJc4ko.js";import{G as fe}from"./GLTFLoader.dE1qf7EY.js";const S=new WeakMap;class pe extends H{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,s){const o=new I(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,n=>{this.parse(n,t,s)},r,s)}parse(e,t,r=()=>{}){this.decodeDracoFile(e,t,null,null,D,r).catch(r)}decodeDracoFile(e,t,r,s,o=q,n=()=>{}){const i={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!r,vertexColorSpace:o};return this.decodeGeometry(e,i).then(t).catch(n)}decodeGeometry(e,t){const r=JSON.stringify(t);if(S.has(e)){const c=S.get(e);if(c.key===r)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const o=this.workerNextTaskID++,n=e.byteLength,i=this._getWorker(o,n).then(c=>(s=c,new Promise((h,d)=>{s._callbacks[o]={resolve:h,reject:d},s.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return i.catch(()=>!0).then(()=>{s&&o&&this._releaseTask(s,o)}),S.set(e,{key:r,promise:i}),i}_createGeometry(e){const t=new Q;e.index&&t.setIndex(new E(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const s=e.attributes[r],o=s.name,n=s.array,i=s.itemSize,c=new E(n,i);o==="color"&&(this._assignVertexColorSpace(c,s.vertexColorSpace),c.normalized=!(n instanceof Float32Array)),t.setAttribute(o,c)}return t}_assignVertexColorSpace(e,t){if(t!==D)return;const r=new Z;for(let s=0,o=e.count;s<o;s++)r.fromBufferAttribute(e,s),X.toWorkingColorSpace(r,D),e.setXYZ(s,r.r,r.g,r.b)}_loadLibrary(e,t){const r=new I(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((s,o)=>{r.load(e,s,void 0,o)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(r=>{const s=r[0];e||(this.decoderConfig.wasmBinary=r[1]);const o=he.toString(),n=["/* draco decoder */",s,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([n]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(o){const n=o.data;switch(n.type){case"decode":s._callbacks[n.id].resolve(n);break;case"error":s._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,o){return s._taskLoad>o._taskLoad?-1:1});const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function he(){let a,e;onmessage=function(n){const i=n.data;switch(i.type){case"init":a=i.decoderConfig,e=new Promise(function(d){a.onModuleLoaded=function(m){d({draco:m})},DracoDecoderModule(a)});break;case"decode":const c=i.buffer,h=i.taskConfig;e.then(d=>{const m=d.draco,l=new m.Decoder;try{const y=t(m,l,new Int8Array(c),h),w=y.attributes.map(f=>f.array.buffer);y.index&&w.push(y.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:y},w)}catch(y){console.error(y),self.postMessage({type:"error",id:i.id,error:y.message})}finally{m.destroy(l)}});break}};function t(n,i,c,h){const d=h.attributeIDs,m=h.attributeTypes;let l,y;const w=i.GetEncodedGeometryType(c);if(w===n.TRIANGULAR_MESH)l=new n.Mesh,y=i.DecodeArrayToMesh(c,c.byteLength,l);else if(w===n.POINT_CLOUD)l=new n.PointCloud,y=i.DecodeArrayToPointCloud(c,c.byteLength,l);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!y.ok()||l.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+y.error_msg());const f={index:null,attributes:[]};for(const u in d){const k=self[m[u]];let L,_;if(h.useUniqueIDs)_=d[u],L=i.GetAttributeByUniqueId(l,_);else{if(_=i.GetAttributeId(l,n[d[u]]),_===-1)continue;L=i.GetAttribute(l,_)}const R=s(n,i,l,u,k,L);u==="color"&&(R.vertexColorSpace=h.vertexColorSpace),f.attributes.push(R)}return w===n.TRIANGULAR_MESH&&(f.index=r(n,i,l)),n.destroy(l),f}function r(n,i,c){const d=c.num_faces()*3,m=d*4,l=n._malloc(m);i.GetTrianglesUInt32Array(c,m,l);const y=new Uint32Array(n.HEAPF32.buffer,l,d).slice();return n._free(l),{array:y,itemSize:1}}function s(n,i,c,h,d,m){const l=m.num_components(),w=c.num_points()*l,f=w*d.BYTES_PER_ELEMENT,u=o(n,d),k=n._malloc(f);i.GetAttributeDataArrayForAllPoints(c,m,u,f,k);const L=new d(n.HEAPF32.buffer,k,w).slice();return n._free(k),{name:h,array:L,itemSize:l}}function o(n,i){switch(i){case Float32Array:return n.DT_FLOAT32;case Int8Array:return n.DT_INT8;case Int16Array:return n.DT_INT16;case Int32Array:return n.DT_INT32;case Uint8Array:return n.DT_UINT8;case Uint16Array:return n.DT_UINT16;case Uint32Array:return n.DT_UINT32}}}const g={key:[0,0,0],ease:new v,up:new v(0,1,0),rotate:new $,current:"Run",fadeDuration:.5,runVelocity:400,walkVelocity:80};function O(a){const e=g.key;switch(a.code){case"ArrowUp":case"KeyW":case"KeyZ":e[0]=-1;break;case"ArrowDown":case"KeyS":e[0]=1;break;case"ArrowLeft":case"KeyA":case"KeyQ":e[1]=-1;break;case"ArrowRight":case"KeyD":e[1]=1;break;case"ShiftLeft":case"ShiftRight":e[2]=1;break}}function W(a){const e=g.key;switch(a.code){case"ArrowUp":case"KeyW":case"KeyZ":e[0]=e[0]<0?0:e[0];break;case"ArrowDown":case"KeyS":e[0]=e[0]>0?0:e[0];break;case"ArrowLeft":case"KeyA":case"KeyQ":e[1]=e[1]<0?0:e[1];break;case"ArrowRight":case"KeyD":e[1]=e[1]>0?0:e[1];break;case"ShiftLeft":case"ShiftRight":e[2]=0;break}}function G(a){a.button===2&&(g.key[0]===0?g.key[0]=-1:g.key[0]=0)}function me(){const a=new Y(16777215,2);a.castShadow=!0,a.position.set(0,5,-2),a.shadow.camera.visible=!0;const e=a.shadow.camera;return e.far=300,e.near=100,e.left=-100,e.right=100,e.top=100,e.bottom=-200,a}const ye=a=>{const e=new J(a.scene),t=a.animations,r={Idle:e.clipAction(t[0]),Walk:e.clipAction(t[3]),Run:e.clipAction(t[1])};for(const s in r){const o=r[s];o.enabled=!0,o.setEffectiveTimeScale(1),s!=="Idle"&&o.setEffectiveWeight(0)}return{mixer:e,actions:r}};function ge(a,e,t,r){const s=a.getLocalInfoFromWorld(r);if(s){const o=e.target.clone();e.target.copy(s.point),o.sub(e.target),t.position.sub(o)}}function we(a,e,t,r,s,o,n){const i=g.fadeDuration,c=g.key,h=g.up,d=g.ease,m=g.rotate,l=e.getAzimuthalAngle(),w=!(c[0]===0&&c[1]===0)?c[2]?"Run":"Walk":"Idle";if(g.current!=w){const f=o[w],u=o[g.current];g.current=w,f.enabled=!0,f.setEffectiveTimeScale(1),f.setEffectiveWeight(1),u.fadeOut(i),f.reset().fadeIn(i).play()}if(g.current!=="Idle"){let f=function(_){return Math.atan2(Math.sin(_),Math.cos(_))};const u=g.current=="Run"?g.runVelocity:g.walkVelocity;d.set(c[1],0,c[0]).multiplyScalar(u*n);const k=f(Math.atan2(d.x,d.z)+l);m.setFromAxisAngle(h,k),g.ease.applyAxisAngle(h,l);const L=e.target.clone().add(d);ge(t,e,a,L),r.quaternion.rotateTowards(m,-.05),r.position.copy(e.target)}s.update(n)}const ke=async(a,e,t)=>{const r=await _e(a),s=r.scene,o=me();o.target=s,s.add(o);const{mixer:n,actions:i}=ye(r),c=e.renderer.domElement;return c.addEventListener("keydown",O),c.addEventListener("keyup",W),c.addEventListener("mousedown",G),e.addEventListener("update",h=>we(e.camera,e.controls,t,s,n,i,h.delta)),e.scene.add(s),s};async function _e(a){const e=new pe;e.setDecoderPath("../lib/draco/gltf/");const t=new fe;t.setDRACOLoader(e);const r=await t.loadAsync(a),s=r.scene;return s.scale.setScalar(50),s.traverse(function(o){o instanceof F&&(o.name=="vanguard_Mesh"?(o.castShadow=!0,o.receiveShadow=!0,o.material.metalness=1,o.material.roughness=.2,o.material.color.set(1,1,1),o.material.metalnessMap=o.material.map):(o.material.metalness=1,o.material.roughness=0,o.material.transparent=!0,o.material.opacity=.8,o.material.color.set(1,1,1)))}),r}const Ae=(a,e)=>{a.removeFromParent(),a.traverse(function(t){t instanceof F&&(t.material.dispose(),t.geometry.dispose())}),e.removeEventListener("keydown",O),e.removeEventListener("keyup",W),e.removeEventListener("mousedown",G)},Le=()=>{const a=ee.create({imgSource:new oe,demSource:new te,lon0:90});return a.rotateX(-Math.PI/2),a.receiveShadow=!0,a},be=()=>{const a=new se(void 0,{antialias:!0,logarithmicDepthBuffer:!1});return a.controls.enableDamping=!1,a.controls.controlsMode="ORBIT",a.controls.enablePan=!1,a.controls.stopListenToKeyEvents(),a.renderer.shadowMap.enabled=!0,a.dirLight.intensity=.5,a.renderer.toneMapping=re,a.renderer.toneMappingExposure=.6,a},ve=()=>{const a=Le(),e=be();return setTimeout(()=>{e.addEventListener("update",()=>{j(a,e.camera)})},5e3),{viewer:e,map:a}},Te=a=>{const{viewer:e,map:t}=ve();return M(()=>{a&&a.value&&(e.addTo(a.value),e.scene.add(t))}),U(()=>{t.dispose()}),{viewer:e,map:t}},De={class:"demo-container"},Se={class:"state"},Re={class:"location"},Ce={class:"loading"},xe={class:"model-state"},Pe={class:"options"},Ie={for:"fogFactor"},Ee={style:{display:"flex","align-items":"center"}},Me=N({__name:"Walk",setup(a){const e=T(void 0),{viewer:t,map:r}=Te(e),s=ae(r,t),o=ie(r),n=T(new v);de(t.scene);const{fogFactor:i,fogColor:c}=ue(t),h=T();ce(t.controls,h);const d=T(),m=le(d),l=()=>{m.update();const f=r.getLocalInfoFromScreen(t.camera,new ne);f&&n.value.copy(f.location)},y=(f,u)=>{t.controls.target.copy(r.geo2world(f)),t.camera.position.copy(r.geo2world(u))};let w;return M(async()=>{t.addEventListener("update",l),w=await ke("../../model/Soldier.glb",t,r);const f=new v(94.39977,36.0022,4085.5),u=new v(94.4003,35.9989,4185);y(f,u),w.position.copy(t.controls.target)}),U(()=>{Ae(w,t.renderer.domElement)}),(f,u)=>(V(),B("div",De,[p("div",{ref_key:"viewerRef",ref:e,class:"viewer"},null,512),u[3]||(u[3]=p("div",{id:"help"},[p("b",null,"方向键|WASD 移动, shift加速")],-1)),p("div",{class:"compass",ref_key:"compassRef",ref:h},null,512),p("div",Se,[p("div",Re,[p("span",null,"经度："+A(b(s).x.toFixed(6))+"° ",1),p("span",null,"纬度："+A(b(s).y.toFixed(6))+"° ",1),p("span",null,"海拔："+A(b(s).z.toFixed(1))+"m ",1)]),p("div",Ce,A(b(o)),1)]),p("div",xe,[p("span",null,"经度:"+A(n.value.x.toFixed(6))+"°",1),p("span",null,"纬度:"+A(n.value.y.toFixed(6))+"°",1),p("span",null,"高度:"+A(n.value.z.toFixed(1))+"m",1)]),p("div",Pe,[p("label",Ie,[K("雾浓度: "+A(b(i))+" ",1),C(p("input",{type:"range",id:"fogFactor",min:"0",max:"2",step:"0.01","onUpdate:modelValue":u[0]||(u[0]=k=>P(i)?i.value=k:null)},null,512),[[x,b(i)]])]),p("div",Ee,[u[2]||(u[2]=p("label",{for:"fogColor"},"雾颜色: ",-1)),C(p("input",{type:"color",id:"fogColor","onUpdate:modelValue":u[1]||(u[1]=k=>P(c)?c.value=k:null)},null,512),[[x,b(c)]])])]),p("div",{class:"stats",ref_key:"statsRef",ref:d},null,512)]))}}),Ve=z(Me,[["__scopeId","data-v-856aaf74"]]);export{Ve as default};
